\section{Less commonly used functions in LANS}
\label{sec:level3}

This section describes functions of Look@NanoSIMS that are useful under special circumstances. Many of these functions have been added based on stimulus from colleagues and collaborators, who wanted to look at their NanoSIMS data in a special way. Thus, these functions likely distinguish Look@NanoSIMS from other programs used for NanoSIMS data processing.

%%

\subsection{Hue intensity modulation based on rescaled ion counts}
\setcounter{step}{0}

\goldbox{}
Due to the statistical properties of the ion count data, ratio images may be noisy in areas where the ion counts of the denominator are low, possibly leading to distraction. Hue modulation intensity is designed to visually supress the noise and thus highlight the ratios in areas of interest. 
\tcbe

For example, if \ttt{12C14N} and \ttt{12C15N} ions are detected from cells deposited on a~polycarbonate filter, the ion counts will be high in areas corresponding to cells but very low in areas corresponding to the filter (Fig.~\ref{fig:hue}A--B). As a~result, the ratio image \ttt{12C15N/12C14N} will be noisy in areas on the filter, distracting the perception of the variation in the \ttt{15N/14N} ratio within cells (Fig.~\ref{fig:hue}C). 

\begin{figure}[!ht]
\centering
\begin{tabular}{ccc}
(A) & (B) & (C) \\
\includegraphics[scale=0.4, valign=t]{figs6/12C14N}
&
\includegraphics[scale=0.4, valign=t]{figs6/12C15N}
&
\includegraphics[scale=0.4, valign=t]{figs6/12C15N-12C14N}
\\
(D) & (E) & (F) \\
\includegraphics[scale=0.4, valign=t]{figs6/12C14Nb}
&
\includegraphics[scale=0.4, valign=t]{figs6/12C15N-12C14Nb}
&
\includegraphics[scale=0.4, valign=t]{figs6/12C15N-12C14Nc}
\end{tabular}
\caption{\label{fig:hue}%
Manipulation of the image appearance by hue intensity modulation. (A) \ttt{12C14N} ion counts, shown in the linear scale. Note the large contrast between the counts from areas with cells and areas on the filter. (B) \ttt{12C15N} ion counts, shown in the logarithmic scale. (C) \ttt{12C15N/12C14N} ratio image. Note the noise in areas on the filter. (D) The same \ttt{12C14N} ion count image as in panel~A, but rescaled such that the areas with and without cells appear white and black, respectively. (E--F) The same \ttt{12C15N/12C14N} ratio image as in panel~C, but with hue intensity modulation applied based on the image in panel~D. The areas on the filter can be shown in black (E) or white (F).}
\end{figure}

Use the following steps to manipulate the ratio image such that the noise perception from areas on the filter will be minimized, as illustrated in Fig.~\ref{fig:hue}E--F.

\s In the main LANS window, rescale the \ttt{12C14N} image (i.e., the mass that defines the cells) such that the cells will appear white and the filter will appear black (Fig.~\ref{fig:hue}D).

\s Select the \lanscb{Modulate hue intensity} checkbox and add number~4 in the \lanstf{mass} field next to it. 

\bul In this example, number 4 is chosen because for this particular dataset, the identifier of the \ttt{12C14N} mass is~4. 

\s Select \lans{Output} $\ra$ \lans{Display ratios} to re-export the \ttt{12C15N/12C14N} ratio image.

\bul The modified image will look as shown in Fig.~\ref{fig:hue}E, with areas on the filter being so dark (black) that the distracting noise is virtually invisible.

\bul You can modify this behaviour by changing the dark areas to bright (white) areas, as explained in the next steps.

\s Select \lans{Preferences} $\ra$ \lans{Additional output options}, and in the window that opens, select the \lanscb{Use white to modulate hue} checkbox and click \lans{Apply}. 

\s Then, back in the main LANS window, change the \lanstf{color} next to the \lanscb{Include ROIs outline} checkbox to \ttt{k} (corresponding to black).

\bul This will ensure that the scale bar will be visible in the exported image (i.e., displayed in black rather than white).

\s Re-export the ratio image by selecting \lans{Output} $\ra$ \lans{Display ratios}.

\bul The modified image will look as shown in Fig.~\ref{fig:hue}F, with areas on the filter being so bright (white) that the distracting noise is virtually invisible.

\vskip3mm\noindent
We emphasize that hue intensity modulation is a~powerful feature and should be used responsibly. It may be used to supress distracting but irrelevant information, such as in the example above, but \emph{not} hide distracting but possibly important information in the image.

\fi

\section{ADD-ONs}

\subsection{Integrating an external image into the NanoSIMS dataset}
\setcounter{step}{0}

NanoSIMS measurements are compatible with correlative imaging. That is, it is possible to first measure a~sample with another imaging technique, such as TEM (transmission electron microscopy), SEM (scanning electron microscopy), or FM (fluorescence microscopy), and then image the very same area on the sample with NanoSIMS. To aid this type of correlative imaging, LANS implements functions that allow you to align an external image with the NanoSIMS image and then import the aligned external image into LANS for the purpose of defining ROIs or creating overlays.

We will use files \ttt{Aphanizomenon.im.zip} (NanoSIMS data) and \ttt{Aphaniz.tif} (FM image) to explain how to use these functions in LANS. These data are available from the same location as the LANS program.

\subsubsection{Aligning an external image with the NanoSIMS image}
\setcounter{step}{0}

In the first step, the external and NanoSIMS images need to be \bb{aligned}. This is necessary because although the different microscopes acquire images of the same area on the sample, the images never correspond perfectly to each other. They can be, for example, rotated, stretched, or otherwise distorted relative to each other. Use the following steps to align the external and NanoSIMS images.

\s 

\subsubsection{Importing an aligned external image}
\setcounter{step}{0}

Once the external image is aligned with the NanoSIMS images, it can be imported into LANS using the following steps.

\s

\subsubsection{Creating overlays between external and NanoSIMS images}
\setcounter{step}{0}

After importing the aligned external image into LANS, the image can be used, effectively, as if it were one of the masses in the NanoSIMS dataset. By default, the name of this `extra mass' is \ttt{ext}. This name can then be used, for instance, as a~template for ROI definition or to create overlays with NanoSIMS images, as described in the following example.

\s

\subsubsection{Resampling of NanoSIMS images to match resolution of an external image}
\setcounter{step}{0}

In addition to rotation, stretching or other types of image distortion, it can happen that the external and NanoSIMS images have a~very different pixel resolution. For example, in the example below, the TEM image has roughly 10-fold higher resolution than the NanoSIMS image. If you want to use such a~high-resolution TEM image as a~template for defining ROIs, which can then be used to quantify ROI-specific NanoSIMS data such as ion counts or ratios, it is necessary rescale the NanoSIMS images to match the resolution of the external image. This can be done by resampling the NanoSIMS images, as described in the following steps.

\s

%%%%

\subsection{Depth variation of isotope ratios --- basic visualization}
\setcounter{step}{0}

During a~NanoSIMS measurement, the sample material is \bb{gradually eroded} by the primary ion beam while the emitted secondary ions are separated based on their mass and counted. The ion counts in the subsequent planes therefore record a~\bb{depth variation} of the elements and isotopes within the sample, making it possible to reconstruct their distribution in~3D. This section describes how to visualize this 3D variation in the most basic way: by displaying lateral profiles along depth in the sample.

In order to obtain a~good quality dataset for 3D reconstruction, the measurement needs to use a~relatively low primary ion current to achieve sufficient lateral resolution. At the same time, the same field of view on the sample needs to be measured repeatedly in \bb{many planes} to erode the sample along a~substantial depth interval (several microns) such that a~meaningful 3D variation in this interval occurs. The number of detected planes can start from several hundreds but can reach up to several thousands of planes (the example below will use 2500 planes). However, one NanoSIMS measurement in the imaging mode is limited to a~maximum of 1000 planes. This means that several measurements of the same sample area need to be done in sequence, leading to multiple raw data files that should be merged and analyzed as one file. Thus, the challenge of isotope ratio visualization along depth additionally includes a~need to load multiple raw files and merge them into a~single stack with potentially several thousands of images. 

Last but not least, it is useful to note that because ion count rates for minor isotopes (e.g., ${}^{13}C$) are typically very low, ion count ratios derived from those minor isotopes (e.g., \ttt{13C/12C}) will generally be noisy if based on data in a~single plane. To maximize the signal-to-noise ratio in depth profiles of isotope ratios while maintaining an acceptable depth resolution, it is better to handle the original ion count data in \bb{blocks} of multiple subsequent planes, where the counts in each block are summed up (across the planes but separately for each pixel in the lateral dimension) and treated as \bb{one} plane.  

Overall, basic visualization of the 3D variation in isotope ratios involves three major steps: (i) loading the raw data in blocks, possibly involving merging of multiple raw datasets, (ii) drift-correcting the planes within each block before they are summed up into a~single plane, and finally (iii) visualization of lateral profiles along depth. This section describes how to do these processing steps in LANS. The example uses datasets \ttt{xxx}, which are available in the same location as the Look@NanoSIMS program. They correspond to 3~consecutive scans of cable bacteria placed on a~polycarbonate filter, each comprizing 1000 planes.

\subsubsection{Loading datasets in blocks, merging multiple datasets}
\setcounter{step}{0}

\s In preparation for the subsequent steps, first select \lans{Input} $\ra$ \lans{Load raw dataset} to load \bb{all} planes in the first dataset.

\bul This step is required to determine the \lanstf{base mass for alignment} and \lanstf{special region for alignment}, which are required later on for drift-correcting planes in a~block.

\s Proceed as described in Sections \ref{sec:display-masses-plane-by-plane} (steps 1--3) and \ref{sec:drift-correction-accumulation} (steps 1--2) to define the \lanstf{base mass for alignment} and \lanstf{special region for alignment}.

\bul At this stage, you should \emph{not} proceed with image accumulation (steps 3--4 in Section~\ref{sec:drift-correction-accumulation}) just yet, because the planes need to be first drift-corrected and accumulated \emph{within} blocks.

\s Select \lans{Input} $\ra$ \lans{Load multiple RAW datasets in blocks}. 

\bul Navigate to the raw files and select them, using the \ttt{Ctrl} key to select multiple files.

\bul Note that this function does \emph{not} require you to load multiple datasets. You can also load planes in blocks for just one dataset. If you do load multiple datasets, however, make sure that they have been acquired with the same pixel resolution (e.g., $256\times 256$ pixels).

\s In the dialog window that opens, specify the \lanstf{block size}, i.e., the number of planes per block. If you are going to load data from multiple datasets, indicate whether or not you want to be able to specify a~different block size for each individual dataset.

\bul In this example, you will use the block size of 40 for the first two datasets and 20 for the third dataset. This is because the last dataset was (accidentally) acquired with $2\times$ longer dwell time than the first two datasets. Thus, in the dialog window, enter 40 for the block size and 1 (\ttt{=yes}) in the second field.

\s Click OK in the dialog window and observe the progress of loading in the Matlab console.

\bul First, the raw data will be loaded. Then, the drift-correction information for planes in each block will be calculated based on the values for \lanstf{Base mass for alignment} and \lanstf{Special region for alignment} (see Step~2 above). Subsequently, this information will be applied to drift-correct and accumulate planes in blocks for each mass.

\bul If you selected multiple raw datasets, the same steps will be repeated for each of them.

\bul After this step is completed, the dataset loaded in LANS will ``behave'' as any other raw dataset loaded via \lans{Input} $\ra$ \lans{Load RAW dataset}. The only difference will be that the individual planes are, in fact, a~sum of multiple planes. Thus, the subsequent analysis will proceed according to the same steps as for any other dataset. 

\s In particular, you need to start with the drift-correction and accumulation of planes via \lans{Input} $\ra$ \lans{Accumulate plane images} (Section~\ref{sec:drift-correction-accumulation}, steps 3--4). 

\bul This is because although the individual planes were drift-corrected \emph{within} each block (during the loading process), the drift-correction also needs to be calculated and applied \emph{between} blocks.

\s Select \lans{Output} $\ra$ \lans{Save FULL PROCESSED data} to save the image stack, for all masses and all planes, in a~Matlab format (extension \ttt{mat}).

\bul This is highly recommended because the loading of data in blocks, accompanied with drift-correction and accumulation, is quite laborious and may be time consuming. Thus, you likely do not want to do it again for the very same dataset or group of datasets. 

\bul When saving the data, use the default filename suggested by LANS, unless you really want to use a~different one. Note that the default filename will end with \ttt{bN.mat}, where \ttt{b} refers to the fact that it corresponds to data loaded in blocks and \ttt{N} corresponds to the number of planes per block (block size).

\bul Beware that if the final dataset contains many planes, the exported \ttt{mat} file can be quite large (e.g., hundreds of Mb). Still, this is an acceptable price to pay for not having to load the same multiple datasets in blocks again.

%%

\subsubsection{Visualization of lateral profiles along depth in the sample}
\setcounter{step}{0}

Although you can perform this analysis with any NanoSIMS dataset, it is most useful for datasets that have been loaded in blocks, as described in the previous section.

\s In the main LANS window, select the \lanscb{Display lateral profiles} checkbox in the \ttt{Output options} box. 

\bul If you only want to focus on lateral profiles, it is a~good idea if you deselect all other checkboxes (except those for exporting ASCII data and PDF graphics).

\s In the \lanstf{expression} and \lanstf{scale} fields, specify the formulas for the ion count ratios you want to analyze and the corresponding scale. 

\bul In this example, you will look at depth profiles of ${}^{13}C/^{12}C$, ${}^{18}O/^{16}O$, CN, P and O. Thus, enter \ttt{13C14N/12C14N}, \ttt{18O/16O}, \ttt{12C14N}, \ttt{31P} and \ttt{16O} in the expression fields. Then experiment with the optimal scales.

\bul Do not forget to check the corresponding checkboxes next to the formulas.

\s Select \lans{Output} $\ra$ \lans{Display ratios}. 

\s In the top-left corner of the new window that opens (Fig.~\ref{fig:lateral}A), select the variable based on which you want to define a~lateral profile.

\begin{figure}[!ht]
\centering
\begin{tabular}{cc}
A: \includegraphics[scale=0.33, valign=t]{figs3/LANS-lateral1}
&
B: \includegraphics[scale=0.33, valign=t]{figs3/LANS-lateral2}
\end{tabular}
\caption{\label{fig:lateral}%
(A) LANS window for the analysis of variation in ion counts and ion count ratios along a~lateral profile. If the \lanscb{Show depth variation} checkbox is selected (marked in blue), the variation along depth will be displayed as well. (B) Results of this particular analysis show, among other things, that polyphosphate inclusions, visible as round areas (in both lateral and depth directions) with markedly higher signals of $P$ and $O$, are roughly homeogeneusly enriched in ${}^{18}O$ relative to the rest of the cell biomass.}
\end{figure}

\bul In this example, you will look at depth variation in the ${}^{18}O/^{16}O$ ratio in polyphosphate inclusions. Thus, select \ttt{18O/16O}.

\s Click on \lans{Draw polyline} to draw a~lateral profile in the image.

\bul The profile can have multiple vertices (hence the name `polyline'), allowing you to create profiles along a~``curved'' profile or even make sharp corners (Fig.~\ref{fig:lateral}A).

\bul Double-click to define the last vertex on the polyline. Although this will stop the polyline drawing mode, you can still continue adding, moving or removing vertices after this point by clicking with the right mouse button on the polyline. You can also move the entire polyline or remove it and start over.

\s Specify the \lanstf{Profile thickness}, in pixels.

\bul For the default value of 1, the lateral profile will be based on values in one pixel nearest to the polyline. Because this may yield a~rather noisy output, it is recommended to use a~greater value here. For example, using a~value of 5~for the profile thickness, the lateral profile will be based on values in 5~pixels nearest to the polyline (2~on one side, 2~on the other side, 1~on the polyline). Thus, you can think of the profile as being based on data in a~`band' following the polyline.

\s Select the \lanscb{Show depth variation} checkbox (highlighted in blue in Fig.~\ref{fig:lateral}A).

\s In the list of variables (highlighted in yellow in Fig.~\ref{fig:lateral}A), select variables that you want to analyze simultaneously.

\bul Hold \ttt{Ctrl} to select multiple variables. In this example, select all variables.

\s Click on \lans{Display lateral profiles}.

\bul This will open a new window showing the variation of the selected variables along the lateral profile (`band') and depth (Fig.~\ref{fig:lateral}B).

\s Select the \lanscb{Export} checkboxes to export the results as ASCII text and PDF images.

\s Click on \lans{Save polyline} to save the polyline coordinates.

\bul You can load it in the future by clicking on \lans{Load polyline}.

%%

\subsection{Loading datasets with more than 8 masses}
\setcounter{step}{0}

\subsection{Semi-automatic ROI classification}
\setcounter{step}{0}

%%%%

\subsection{Exporting graphics as PNG}
\setcounter{step}{0}

By default, graphical output generated by LANS is exported in the PDF format, with files stored in the \ttt{pdf} sub-folder. This output is of publishing quality. Sometimes, however, you may want to export the graphics as bitmaps in the PNG format. One of the reasons for doing this is that the PNG files are usually smaller than the PDF files and are therefore more convenient to include in presentations. Use the following steps to export the graphics as PNG files.

\s In the main LANS window, select \lans{Preferences} $\ra$ \lans{Additional output options}.

\s In the new window that opens, select the \lanscb{PNG} checkbox in the the \ttt{Export graphics} box and click \lans{Apply}.

\s In the main LANS window, export the mass or ratio images by selecting \lans{Output} $\ra$ \lans{Display masses} or \lans{Display ratios}. 

\bul The PNG output will be stored in the \ttt{png} sub-folder. It will look very similar to the PDF output, but it will be  a~bitmap with a~limited resolution rather than vector graphics.

\s Uncheck the \lanscb{PNG} checkbox if you no longer want to export the output as PNG. This will save some disk space.

%%%%

\subsection{Exporting graphics as TIF}
\setcounter{step}{0}

Sometimes, you may want to export the nanoSIMS image data as TIF images. Such images can be used, for example, for quantitative image analysis by other, third-party software.  Use the following steps to export the images of ion counts and ion count ratios as TIF files. 

\s In the main LANS window, select \lans{Preferences} $\ra$ \lans{Additional output options}.

\s In the new window that opens, select the \lanscb{TIFF (if BW)} checkbox in the the \ttt{Export graphics} box and click \lans{Apply}.

\s Back in the main LANS window, select the \lanscb{B/W} checkbox next to the \lanstf{scale} of the mass or ratio image that you want to export as TIF, then select \lans{Output} $\ra$ \lans{Display masses} or \lans{Display ratios} to export the mass or ratio images.

\bul The image data will be exported as a~16-bit grayscale TIF image, stored in the \ttt{tif} sub-folder. 

\bul The dynamic range of the grayscale values in the exported TIF image will correspond to the image \lanstf{scale} set in the main LANS window. For example, if a~\ttt{12C} ion count image is displayed in the scale \ttt{[min max] = [20 25000]}, the grayscale values in the image pixels varying between fully black (intensity 0) and fully white (intensity $2^{16}-1=65535$) will correspond linearly to the dynamic range of the ion counts between 20 and 25000. Similar linear relationship between the image scale and the grayscale values of the exported TIF holds for the ion count ratio images.

\s Uncheck the \lanscb{TIFF (if BW)} checkbox if you no longer want to export the images as TIF. This will save some disk space.
